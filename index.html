<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"content="width=device-width, initial-scale=1.0">
    <title>–ö–û–õ–õ–ê–ñ–§–û–¢–û | –í–ò–î–ï–û</title>
    <style>
        body {
            font-family: 'Segoe UI',sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f7fa;
            color: #333;
        }
        .container {
            max-width: 600px;
            margin: auto;
        }
        h1 {
            text-align: center;
            color: #4a5568;
        }
        .instructions {
            background-color: #e8f4f8;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }
        .step-container {
            display: none;
        }
        .active {
            display:block;
        }
        .grid-selection {
            display:flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
        }
        .grid-item {
            width: 80px;
            height: 80px;
            border: 2px solid #3b82f6;
            display:flex;
            align-items:center;
            justify-content:center;
            cursor:pointer;
            transition: all 0.3s;
            background-color: white;
        }
        .grid-item:hover {
            background-color: #e2e8f0;
        }
        .size-selection {
            display:flex;
            flex-wrap:wrap;
            gap: 10px;
            margin-top: 20px;
        }
        .size-item {
            padding: 10px 15px;
            border: 2px solid #3b82f6;
            cursor:pointer;
            border-radius: 5px;
            background-color: white;
        }
        .size-item:hover {
            background-color: #e2e8f0;
        }
        .btn {
            padding: 10px 20px;
            background-color: #3b82f6;
            color: white;
            border:none;
            border-radius: 5px;
            cursor:pointer;
            margin-top: 20px;
            display:block;
            width: 100%;
            text-align:center;
        }
        .btn:hover {
            background-color: #2563eb;
        }
        .upload-area {
            border: 2px dashed #cbd5e0;
            padding: 30px;
            text-align:center;
            margin-top: 20px;
            cursor:pointer;
            background-color: #f8fafc;
        }
        .upload-area:hover {
            background-color: #f1f5f9;
        }
        .file-count {
            text-align:center;
            font-weight:bold;
            color: #2d3748;
            margin: 10px 0;
        }
        .loading {
            text-align:center;
            padding: 20px;
        }
        .collage-preview {
            width: 100%;
            aspect-ratio: 9/16;
            border: 1px solid #ddd;
            overflow:hidden;
            margin-top: 20px;
            position:relative;
            background-color: #000;
        }
        .video-preview {
            position:absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .video-preview video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .grid-preview {
            display:flex;
            justify-content:center;
            gap: 10px;
            margin: 10px 0;
        }
        .grid-cell {
            width: 40px;
            height: 40px;
            border: 1px solid #ccc;
            background-color: #eee;
        }
        .grid-cell.video {
            background-color: #3b82f6;
            display:flex;
            align-items:center;
            justify-content:center;
            color:white;
            font-size: 12px;
        }
        .grid-cell.photo {
            background-color: #4ade80;
            display:flex;
            align-items:center;
            justify-content:center;
            color:white;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>–ö–û–õ–õ–ê–ñ–§–û–¢–û |–í–ò–î–ï–û</h1>
        <divid="step1"class="step-container active">
            <divclass="instructions">
                <p><strong>–í—ã–±–µ—Ä–∏—Ç–µ —Å–µ—Ç–∫—É–¥–ª—è–∫–æ–ª–ª–∞–∂–∞:</strong></p>
            </div>
            <divclass="grid-selection">
                <divclass="grid-item"data-grid="2x2">2x2</div>
                <divclass="grid-item"data-grid="3x3">3x3</div>
                <divclass="grid-item"data-grid="3x1">3x1</div>
                <divclass="grid-item"data-grid="1x3">1x3</div>
                <divclass="grid-item"data-grid="2x1">2x1</div>
                <divclass="grid-item"data-grid="1x2">1x2</div>
            </div>
            <buttonclass="btn"id="nextStep1"style="display:none;">–î–∞–ª–µ–µ</button>
        </div>
        <divid="step2"class="step-container">
            <divclass="instructions">
                <p><strong>–í—ã–±–µ—Ä–∏—Ç–µ—Ä–∞–∑–º–µ—Ä–∫–æ–ª–ª–∞–∂–∞:</strong></p>
            </div>
            <divclass="size-selection">
                <divclass="size-item"data-size="9:16">9:16</div>
                <divclass="size-item"data-size="3:4">3:4</div>
                <divclass="size-item"data-size="1:1">1:1</div>
                <divclass="size-item"data-size="4:3">4:3</div>
                <divclass="size-item"data-size="16:9">16:9</div>
            </div>
            <buttonclass="btn"id="nextStep2">–î–∞–ª–µ–µ</button>
        </div>
        <divid="step3"class="step-container">
            <divclass="instructions">
                <p><strong>–ó–∞–≥—Ä—É–∑–∏—Ç–µ—Ñ–æ—Ç–æ–∏/–∏–ª–∏–≤–∏–¥–µ–æ:</strong></p>
                <pclass="file-count">–ó–∞–≥—Ä—É–∂–µ–Ω–æ:<spanid="currentCount">0</span>/<spanid="requiredCount">4</span>—Ñ–∞–π–ª–æ–≤</p>
            </div>
            <divclass="upload-area"id="uploadArea">
                –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ—Ñ–æ—Ç–æ–∏–ª–∏–≤–∏–¥–µ–æ—Å—é–¥–∞
            </div>
            <input type="file"id="fileInput"accept="image/*,video/*"multiplestyle="display:none;">
            <buttonclass="btn"id="createCollageBtn"style="display:none;">–°–æ–∑–¥–∞—Ç—å–∫–æ–ª–ª–∞–∂</button>
        </div>
        <divid="step4"class="step-container">
            <divclass="instructions">
                <p><strong>–ö–æ–ª–ª–∞–∂—Å–æ–∑–¥–∞–Ω!</strong></p>
            </div>
            <divclass="collage-preview"id="collagePreview">
                <!-- –∑–¥–µ—Å—å–±—É–¥–æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è–∫–æ–ª–ª–∞–∂-->
            </div>
            <buttonclass="btn"onclick="downloadCollage()">–°–∫–∞—á–∞—Ç—å–∫–æ–ª–ª–∞–∂</button>
            <buttonclass="btn"onclick="changeSize()">–ò–∑–º–µ–Ω–∏—Ç—å—Ä–∞–∑–º–µ—Ä–∫–æ–ª–ª–∞–∂–∞üëáüèª</button>
            <buttonclass="btn"onclick="newCollage()">–ù–æ–≤—ã–µ–∫–æ–ª–ª–∞–∂</button>
        </div>
        <divid="loading"class="loading"style="display:none;">
            <p>–°–æ–∑–¥–∞–µ–º–∫–æ–ª–ª–∞–∂,—Å–∫–æ—Ä–æ–≤—Å—ë–±—É–¥–µ—Ç!</p>
        </div>
    </div>
    <script>
        //–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ–¥–ª—è—Ö—Ä–∞–Ω–µ–Ω–∏—è–¥–∞–Ω–Ω—ã
        let selectedGrid = '';
        letselectedSize = '';
        letuploadededFiles = [];
        let requiredCount = 4;
        letoriginalFiles = []; //–¥–ª—è—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è–æ—Ä–∏–≥–Ω–∞–ª—å–Ω—ã—Ö—Ñ–∞–π–ª–æ–≤–ø—Ä–∏–∏–∑–º–µ–Ω–µ–Ω–∏–∏—Ä–∞–∑–º–µ—Ä–∞
        
        //–§—É–Ω–∫—Ü–∏—è–¥–ª—è—Ä–∞—Å—á–µ—Ç–∞–Ω–µ–æ–±—Ö–æ–¥–∏–º–∏–º–æ–≥–æ–∫–æ–ª–∏—á–µ—Å—Ç–≤–∞—Ñ–∞–π–ª–æ–≤
        functiongetRequiredCount(grid) {
            constcounts = {
                "2x2": 4,
                "3x3": 9,
                "3x1": 3,
                "1x3": 3,
                "2x1": 2,
                "1x2": 2
            };
            returncounts[grid] || 4;
        }
        
        //–§—É–Ω–∫—Ü–∏—è–¥–ª—è–ø–µ—Ä–µ—Ö–æ–¥–∞–º–µ–∂–¥—É—à–∞–≥–∞–º–∏
        functionshowStep(stepNumber) {
            //–°–∫—Ä—ã—Ç—å–≤—Å–µ—à–∞–≥–∏
            document.querySelectorAll('.step-container').forEach(step => {
                step.classList.remove('active');
            });
            //–ü–æ–∫–∞–∑–∞—Ç—å–Ω—É–∂–Ω—ã–π—à–∞–≥
            document.getElementById('step' + stepNumber).classList.add('active');
        }
        
        //–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏–¥–ª—è–≤—ã–±–æ—Ä–∞—Å–µ—Ç–∫–∏
        document.querySelectorAll('.grid-item').forEach(item => {
            item.addEventListener('click', () => {
                selectedGrid = item.dataset.grid;
                document.querySelectorAll('.grid-item').forEach(el=>el.style.borderColor = '#3b82f6');
                item.style.borderColor = '#ef4444';
                document.getElementById('nextStep1').style.display = 'block';
            });
        });
        
        //–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏–¥–ª—è–∫–Ω–æ–ø–∫–∏"–î–∞–ª–µ–µ"–ø–æ—Å–ª–µ–≤—ã–±–æ—Ä–∞—Å–µ—Ç–∫–∏
        document.getElementById('nextStep1').addEventListener('click', () => {
            if (selectedGrid) {
                requiredCount = getRequiredCount(selectedGrid);
                document.getElementById('requiredCount').textContent = requiredCount;
                showStep(2);
            }
        });
        
        //–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏–¥–ª—è–≤—ã–±–æ—Ä–∞—Ä–∞–∑–º–µ—Ä–∞
        document.querySelectorAll('.size-item').forEach(item => {
            item.addEventListener('click', () => {
                selectedSize =item.dataset.size;
                document.querySelectorAll('.size-item').forEach(el=>el.style.borderColor ='#3b82f6');
                item.style.borderColor = '#ef4444';
                document.getElementById('nextStep2').style.display = 'block';
            });
        });
        
        //–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏–¥–ª—è–∫–Ω–æ–ø–∫–∏"–î–∞–ª–µ–µ"–ø–æ—Å–ª–µ–≤—ã–±–æ—Ä–∞—Ä–∞–∑–º–µ—Ä–∞
        document.getElementById('nextStep2').addEventListener('click', () => {
            if (selectedSize) {
                showStep(3);
            }
        });
        
        //–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∑–∞–≥—Ä—É–∑–∫–∏—Ñ–∞–π–ª–æ–≤
        document.getElementById('uploadArea').addEventListener('click', () => {
            document.getElementById('fileInput').click();
        });
        
        document.getElementById('fileInput').addEventListener('change', function(event) {
            const files = event.target.files;
            uploadedFiles = Array.from(files);
            originalFiles = [...uploadededFiles]; //–°–æ—Ö—Ä–∞–Ω—è–µ–º–æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ–§–∞–π–ª—ã
            //–û–±–Ω–æ–≤–ª—è–µ–º—Å—á–µ—Ç—á–∏–∫
            document.getElementById('currentCount').textContent = uploadededFiles.length;
            //–ü–æ–∫–∞–∑—ã–≤–∞–µ–º–∫–Ω–æ–ø–∫—É"–°–æ–∑–¥–∞—Ç—å–∫–æ–ª–ª–∞–∂"–µ—Å–ª–∏—Ñ–∞–π–ª–æ–≤–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–Ω–æ
            if (uploadededFiles.length>=requiredCount) {
                document.getElementById('createCollageBtn').style.display = 'block';
            }
        });
        
        //–û–±—Ä–∞–±–æ—Ç—á–∏–∫—Å–æ–∑–¥–∞–Ω–∏—è–∫–æ–ª–ª–∞–∂–∞
        document.getElementById('createCollageBtn').addEventListener('click', function() {
            if (uploadededFiles.length>=requiredCount) {
                //–ü–æ–∫–∞–∑—ã–≤–∞–µ–º–∑–∞–≥—Ä—É–∑–∫—É
                document.getElementById('loading').style.display = 'block';
                //–û—Ç–ø—Ä–∞–≤–ª—è–µ–º–∑–∞–ø—Ä–æ—Å–Ω–∞—Å–µ—Ä–≤–µ—Ä–¥–ª—è—Å–æ–∑–¥–∞–Ω–∏–∏—è–∫–æ–ª–ª–∞–∂–∞
                fetch('/create-collage', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
 
                        grid: selectedGrid,
                        size:selectedSize,
                        media: uploadededFiles.map(file => ({
 
                            type: file.type.split('.').pop() === 'mp4' ? 'video' : 'photo',
                            url: URL.createObjectURL(file)
                        }))
                    })
                })
                .then(response => response.json())
                .then(result => {
                    //–°–∫—Ä—ã–≤–∞–µ–º–∑–∞–≥—Ä—É–∑–∫—É
                    document.getElementById('loading').style.display = 'none';
                    //–ü–æ–∫–∞–∑—ã–≤–∞–µ–º—Ä–µ–∑—É–ª—å—Ç–∞—Ç—É–ª—Ç–∞—Ç
                    showStep(4);
                    //–û—Ç–æ–±—Ä–∞–∂–∞–µ–º–∫–æ–ª–ª–∞–∂–∏–∑—Å–µ—Ä–≤–µ—Ä–∞
                    if (result.status === 'success') {
                        displayCollageFrom(result.url);
                    } else {
                        alert('–û—à–∏–±–∫–∞—Å–æ–∑–¥–∞–Ω–∏–∏—è–∫–æ–ª–ª–∞–∂–∞:' + result.message);
                    }
                })
                .catch(error => {
                    console.error('–æ—à–∏–±–∫–∞:', error);
                    document.getElementById('loading').style.display = 'none';
                    alert('–æ—à–∏–±–∫–∞–ø—Ä–∏—Å–æ–∑–¥–∞–Ω–∏–∏–∫–æ–ª–ª–∞–∂–∞:' + error.message);
                });
            }
        });
        
        //–§—É–Ω–∫—Ü–∏—è–¥–ª—è–æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è–∫–æ–ª–ª–∞–∂–∞–∏–∑—Å–µ—Ä–≤–µ—Ä–∞
        functiondisplayCollageFrom(serverUrl) {
            const preview = document.getElementById('collagePreview');
            preview.innerHTML = '';
            
            //–°–æ–∑–¥–∞–µ–º—ç–ª–µ–º–µ–Ω—Ç–¥–ª—è–æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è–∫–æ–ª–ª–∞–∂–∞
            const videoElement = document.createElement('video');
            videoElement.src = serverUrl;
            videoElement.controls = true;
            videoElement.autoplay = true;
            videoElement.style.width = '100%';
            videoElement.style.height = '100%';
            videoElement.style.objectFit = 'cover';
            
            preview.appendChild(videoElement);
        }
        
        //–§—É–Ω–∫—Ü–∏—è–¥–ª—è–æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è–∫–æ–ª–ª–∞–∂–∞(–ª–æ–∫–∞–ª—å–Ω–∞—è–∞—è–≤–µ—Ä—Å–∏—è)
        functiondisplayCollage() {
            constpreview = document.getElementById('collagePreview');
            preview.innerHTML = '';
            //–ü—Ä–æ–≤–µ—Ä—è–µ–º,—á—Ç–æ—É–Ω–∞—Å–µ—Å—Ç—å—Ñ–∞–π–ª—ã
            if (!uploadededFiles || uploadededFiles.length === 0) {
                preview.innerHTML = '<p style="text-align:center;color:red;">–ù–µ—Ç—Ñ–∞–π–ª–æ–≤–¥–ª—è–æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</p>';
                return;
            }
            //–°–æ–∑–¥–∞–µ–º—Å–µ—Ç–∫—É–≤–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏–æ—Ç–≤—ã–±—Ä–∞–Ω–Ω–æ–π—Å–µ—Ç–∫–∏
            if (selectedGrid=== "2x2") {
                constcols = 2,rows = 2;
                const cellWidth = 100 /cols;
                const cellHeight = 100 / rows;
                for (let r = 0; r <rows; r++) {
                    for (let c = 0; c<cols; c++) {
                        constidx = r * cols + c;
                        if (idx<uploadededFiles.length) {
                            constfile = uploadededFiles[idx];
                            constdiv = document.createElement('div');
                            div.style.position = 'absolute';
                            div.style.width = `${cellWidth}%`;
                            div.style.height =`${cellHeight}%`;
                            div.style.left = `${c * cellWidth}%`;
                            div.style.top = `${r * cellHeight}%`;
                            div.style.border = '1px solidrgba(255,255,255,0.3)';
                            div.style.overflow = 'hidden';
                            if (file.type.startsWith('image/')) {
                                constimg = document.createElement('img');
                                img.src =URL.createObjectURL(file);
                                img.style.width = '100%';
                                img.style.height = '100%';
                                img.style.objectFit = 'cover';
                                div.appendChild(img);
                            } else if (file.type.startsWith('video/')) {
                                const video = document.createElement('video');
                                video.src =URL.createObjectURL(file);
                                video.controls = false;
                                video.autoplay = true;
                                video.loop = true;
                                video.muted = true;
                                video.style.width = '100%';
                                video.style.height = '100%';
                                video.style.objectFit = 'cover';
                                div.appendChild(video);
                            }
                            preview.appendChild(div);
                        }
                    }
                }
            } else if (selectedGrid=== "3x3") {
                constcols = 3,rows = 3;
                const cellWidth = 100 /cols;
                const cellHeight = 100 /rows;
                for (let r = 0; r<rows; r++) {
                    for (let c = 0; c<cols; c++) {
                        constidx = r *cols + c;
                        if (idx<uploadededFiles.length) {
                            constfile =uploadededFiles[idx];
                            constdiv = document.createElement('div');
                            div.style.position = 'absolute';
                            div.style.width =`${cellWidth}%`;
                            div.style.height =`${cellHeight}%`;
                            div.style.left =`${c*cellWidth}%`;
                            div.style.top =`${r*cellHeight}%`;
                            div.style.border = '1px solidrgba(255,255,255,0.3)';
                            div.style.overflow = 'hidden';
                            if (file.type.startsWith('image/')) {
                                const img = document.createElement('img');
                                img.src =URL.createObjectURL(file);
                                img.style.width = '100%';
                                img.style.height = '100%';
                                img.style.objectFit = 'cover';
                                div.appendChild(img);
                            } else if (file.type.startsWith('video/')) {
                                const video = document.createElement('video');
                                video.src =URL.createObjectURL(file);
                                video.controls = false;
                                video.autoplay = true;
                                video.loop = true;
                                video.muted = true;
                                video.style.width = '100%';
                                video.style.height = '100%';
                                video.style.objectFit = 'cover';
                                div.appendChild(video);
                            }
                            preview.appendChild(div);
                        }
                    }
                }
            } else if (selectedGrid=== "3x1") {
                constcols = 1,rows = 3;
                const cellWidth = 100 /cols;
                const cellHeight = 100 /rows;
                for (let r = 0; r<rows; r++) {
                    for (let c = 0; c<cols; c++) {
                        constidx = r *cols + c;
                        if (idx<uploadededFiles.length) {
                            constfile =uploadededFiles[idx];
                            constdiv = document.createElement('div');
                            div.style.position = 'absolute';
                            div.style.width =`${cellWidth}%`;
                            div.style.height =`${cellHeight}%`;
                            div.style.left =`${c*cellWidth}%`;
                            div.style.top =`${r*cellHeight}%`;
                            div.style.border = '1px solidrgba(255,255,255,0.3)';
                            div.style.overflow = 'hidden';
                            if (file.type.startsWith('image/')) {
                                const img = document.createElement('img');
                                img.src =URL.createObjectURL(file);
                                img.style.width = '100%';
                                img.style.height = '100%';
                                img.style.objectFit = 'cover';
                                div.appendChild(img);
                            } else if (file.type.startsWith('video/')) {
                                const video = document.createElement('video');
                                video.src =URL.createObjectURL(file);
                                video.controls = false;
                                video.autoplay = true;
                                video.loop = true;
                                video.muted = true;
                                video.style.width = '100%';
                                video.style.height = '100%';
                                video.style.objectFit = 'cover';
                                div.appendChild(video);
                            }
                            preview.appendChild(div);
                        }
                    }
                }
            } else if (selectedGrid=== "1x3") {
                constcols = 3,rows = 1;
                const cellWidth = 100 /cols;
                const cellHeight = 100 /rows;
                for (let r = 0; r<rows; r++) {
                    for (let c = 0; c<cols; c++) {
                        constidx = r *cols + c;
                        if (idx<uploadededFiles.length) {
                            constfile =uploadededFiles[idx];
                            constdiv = document.createElement('div');
                            div.style.position = 'absolute';
                            div.style.width =`${cellWidth}%`;
                            div.style.height =`${cellHeight}%`;
                            div.style.left =`${c*cellWidth}%`;
                            div.style.top =`${r*cellHeight}%`;
                            div.style.border = '1px solidrgba(255,255,255,0.3)';
                            div.style.overflow = 'hidden';
                            if (file.type.startsWith('image/')) {
                                constimg = document.createElement('img');
                                img.src =URL.createObjectURL(file);
                                img.style.width = '100%';
                                img.style.height = '100%';
                                img.style.objectFit = 'cover';
                                div.appendChild(img);
                            } else if (file.type.startsWith('video/')) {
                                const video = document.createElement('video');
                                video.src =URL.createObjectURL(file);
                                video.controls = false;
                                video.autoplay = true;
                                video.loop = true;
                                video.muted = true;
                                video.style.width = '100%';
                                video.style.height = '100%';
                                video.style.objectFit = 'cover';
                                div.appendChild(video);
                            }
                            preview.appendChild(div);
                        }
                    }
                }
            } else if (selectedGrid=== "2x1") {
                constcols = 1,rows = 2;
                const cellWidth = 100 /cols;
                const cellHeight = 100 /rows;
                for (let r = 0; r<rows; r++) {
                    for (let c = 0; c<cols; c++) {
                        constidx = r *cols + c;
                        if (idx<uploadededFiles.length) {
                            constfile =uploadededFiles[idx];
                            constdiv = document.createElement('div');
                            div.style.position = 'absolute';
                            div.style.width =`${cellWidth}%`;
                            div.style.height =`${cellHeight}%`;
                            div.style.left =`${c*cellWidth}%`;
                            div.style.top =`${r*cellHeight}%`;
                            div.style.border = '1px solidrgba(255,255,255,0.3)';
                            div.style.overflow = 'hidden';
                            if (file.type.startsWith('image/')) {
                                const img = document.createElement('img');
                                img.src =URL.createObjectURL(file);
                                img.style.width = '100%';
                                img.style.height = '100%';
                                img.style.objectFit = 'cover';
                                div.appendChild(img);
                            } else if (file.type.startsWith('video/')) {
                                const video = document.createElement('video');
                                video.src =URL.createObjectURL(file);
                                video.controls = false;
                                video.autoplay = true;
                                video.loop = true;
                                video.muted = true;
                                video.style.width = '100%';
                                video.style.height = '100%';
                                video.style.objectFit = 'cover';
                                div.appendChild(video);
                            }
                            preview.appendChild(div);
                        }
                    }
                }
            } else if (selectedGrid=== "1x2") {
                constcols = 2,rows = 1;
                const cellWidth = 100 /cols;
                const cellHeight = 100 /rows;
                for (let r = 0; r<rows; r++) {
                    for (let c = 0; c<cols; c++) {
                        constidx = r *cols + c;
                        if (idx<uploadededFiles.length) {
                            constfile =uploadededFiles[idx];
                            constdiv = document.createElement('div');
                            div.style.position = 'absolute';
                            div.style.width =`${cellWidth}%`;
                            div.style.height =`${cellHeight}%`;
                            div.style.left =`${c*cellWidth}%`;
                            div.style.top =`${r*cellHeight}%`;
                            div.style.borderWidth = '1px solidrgba(255,255,255,0.3)';
                            div.style.overflow = 'hidden';
                            if (file.type.startsWith('image/')) {
                                const img = document.createElement('img');
                                img.src =URL.createObjectURL(file);
                                img.style.width = '100%';
                                img.style.height = '100%';
                                img.style.objectFit = 'cover';
                                div.appendChild(img);
                            } else if (file.type.startsWith('video/')) {
                                const video = document.createElement('video');
                                video.src =URL.createObjectURL(file);
                                video.controls = false;
                                video.autoplay = true;
                                video.loop = true;
                                video.muted = true;
                                video.style.width = '100%';
                                video.style.height = '100%';
                                video.style.objectFit = 'cover';
                                div.appendChild(video);
                            }
                            preview.appendChild(div);
                        }
                    }
                }
            } else {
                //–ü–æ–æ–º–æ–ª—á–∞–Ω–∏—é2x2
                constcols = 2,rows = 2;
                const cellWidth = 100 /cols;
                const cellHeight = 100 /rows;
                for (let r = 0; r<rows; r++) {
                    for (let c = 0; c<cols; c++) {
                        constidx = r *cols + c;
                        if (idx<uploadededFiles.length) {
                            constfile =uploadededFiles[idx];
                            constdiv = document.createElement('div');
                            div.style.position = 'absolute';
                            div.style.width =`${cellWidth}%`;
                            div.style.height =`${cellHeight}%`;
                            div.style.left =`${c*cellWidth}%`;
                            div.style.top =`${r*cellHeight}%`;
                            div.style.borderWidth = '1px solidrgba(255,255,255,0.3)';
                            div.style.overflow = 'hidden';
                            if (file.type.startsWith('image/')) {
                                const img = document.createElement('img');
                                img.src =URL.createObjectURL(file);
                                img.style.width = '100%';
                                img.style.height = '100%';
                                img.style.objectFit = 'cover';
                                div.appendChild(img);
                            } else if (file.type.startsWith('video/')) {
                                const video = document.createElement('video');
                                video.src =URL.createObjectURL(file);
                                video.controls = false;
                                video.autoplay = true;
                                video.loop = true;
                                video.muted = true;
                                video.style.width = '100%';
                                video.style.height = '100%';
                                video.style.objectFit = 'cover';
                                div.appendChild(video);
                            }
                            preview.appendChild(div);
                        }
                    }
                }
            }
        }
        
        //–§—É–Ω–∫—Ü–∏—è–∏–∑–º–µ–Ω–µ–Ω–∏—è—Ä–∞–∑–º–µ—Ä–∞
        functionchangeSize() {
            //–°–æ—Ö—Ä–∞–Ω—è–µ–º—Ç–µ–∫—É—â–∏–µ–§–∞–π–ª—ã–¥–ª—è–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è–ø—Ä–∏–Ω–æ–≤–æ–º—Ä–∞–∑–º–µ—Ä–µ
            originalFiles = [...uploadededFiles];
            //–í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è–∫–≤—ã–±–æ—Ä—É—Ä–∞–∑–º–µ—Ä–∞
            showStep(2);
        }
        
        //–§—É–Ω–∫—Ü–∏—è—Å–∫–∞—á–∏–≤–∞–Ω–∏—è
        functiondownloadCollage() {
            //–ü–æ–ª—É—á–∞–µ–ºURL–∫–æ–ª–ª–∞–∂–∞–∏–∑—Å–µ—Ä–≤–µ—Ä–∞
            fetch('/create-collage', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    grid:selectedGrid,
                    size:selectedSize,
                    media:uploadededFiles.map(file =>({ 
                        type: file.type.split('.').pop() === 'mp4' ? 'video' : 'photo',
                        url:URL.createObjectURL(file)
                    }))
                })
            })
            .then(response =>response.json())
            .then(result => {
                if (result.status === 'success') {
                    //–°–∫–∞—á–∏–≤–∞–µ–º–∫–æ–ª–ª–∞–∂
                    const link = document.createElement('a');
                    link.href = result.url;
                    link.download = 'collage.mp4';
                    link.click();
                } else {
                    alert('–æ—à–∏–±–∫–∞—Å–æ–∑–¥–∞–Ω–∏–∏—è–∫–æ–ª–ª–∞–∂–∞:' + result.message);
                }
            })
            .catch(error => {
                console.error('–æ—à–∏–±–∫–∞:',error);
                alert('–æ—à–∏–±–∫–∞–ø—Ä–∏—Å–æ–∑–¥–∞–Ω–∏–∏–∫–æ–ª–ª–∞–∂–∞:' + error.message);
            });
        }
        
        //–§—É–Ω–∫—Ü–∏—è–Ω–æ–≤–æ–≥–æ–∫–æ–ª–ª–∞–∂–∞
        functionnewCollage() {
            //–°–±—Ä–æ—Å–¥–∞–Ω–Ω—ã
            selectedGrid = '';
            selectedSize = '';
            uploadededFiles = [];
            originalFiles = [];
            requiredCount = 4;
            //–°–±—Ä–æ—Å–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
            document.querySelectorAll('.grid-item').forEach(el=>el.style.borderColor = '#3b82f6');
            document.querySelectorAll('.size-item').forEach(el=>el.style.borderColor ='#3b82f6');
            document.getElementById('currentCount').textContent = '0';
            document.getElementById('requiredCount').textContent = '4';
            document.getElementById('createCollageBtn').style.display = 'none';
            document.getElementById('collagePreview').innerHTML = '';
            //–í–æ–∑–≤—Ä–∞—Ç–∫–ø–µ—Ä–≤–æ–º—É—à–∞–≥—É
            showStep(1);
        }
        
        //–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        showStep(1);
    </script>
</body>
</html>
